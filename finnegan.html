<html>

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="dartboard.svg">
  <title>Finnegan</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Pinyon+Script&family=Roboto+Mono&family=Oxanium:wght@500&display=swap"
    rel="stylesheet">
  <style>
    body {
      background-color: black;
    }

    td.title {
      font-family: 'Pinyon Script', cursive;
      font-size: 100px;
      color: rgb(59, 134, 8);
    }

    table.speech {
      font-family: 'Roboto Mono', monospace;
      font-size: 16px;
      color: rgb(228, 169, 9);
      cursor: pointer;
    }

    tr.nonscorespeech:hover {
      color:rgb(224, 17, 69);
    }

    tr.scorespeech {
      cursor: default;
    }

    tr.lang:hover {
      color:rgb(224, 17, 69);
    }

    tr.lang {
      color: rgb(90 128 239);
    }

    td.title {
      vertical-align: middle;
    }

    table.score {
      font-family: 'Oxanium', cursive;
      font-size: 20px;
      color: rgb(224, 17, 69);
    }

    table.scoreButtons {
      font-family: 'Oxanium', cursive;
      font-size: 20px;
      color: white;
      cursor: pointer;
    }

    td.good {
      text-align: right;
      background-color: rgb(28, 121, 48);
    }

    td.bad {
      text-align: right;
      background-color: rgb(90, 88, 88);
    }

    td.good:hover {
      background-color: rgb(90, 214, 117);
    }

    td.bad:hover {
      background-color: rgb(155, 156, 155);
    }

    td.scorecell {
      width: 20px;
    }

    td.ignored {
      color: rgb(146, 138, 140);
      width: 20px;
    }

    td.score {
      font-size: 40px;
      color: rgb(245, 229, 10);
    }

    td.currentPlayer {
      font-size: 25px;
      color: rgb(23 255 223);
      white-space: nowrap;
    }

    td.player {
      font-size: 25px;
      color: rgb(147, 89, 201);
      white-space: nowrap;
    }

    .message {
      font-family: 'Oxanium', cursive;
      font-size: 30px;
      padding: 10px;
      background-color: #0777d3;
      color: white;
      cursor: pointer;
    }

    .actionButton {
      font-family: 'Oxanium', cursive;
      font-size: 30px;
      padding: 10px;
      background-color: #0c2f18;
      color: white;
      width: fit-content;
      cursor: pointer;
    }

    .selectedActionButton {
      font-family: 'Oxanium', cursive;
      font-size: 30px;
      padding: 10px;
      background-color: #1f9949;
      color: white;
      width: fit-content;
      cursor: pointer;
    }

    .alert {
      font-family: 'Roboto Mono', monospace;
      font-size: 16px;
      padding: 10px;
      background-color: #0c2f18;
      color: white;
      cursor: pointer;
    }

  </style>

  <script>

    function render(state) {
      renderPreStartConfig(state);
      renderScores(state);
      renderTextToSay(state);
      renderUnrecognizedText(state);
      renderMessage(state);
    }

    function escapeHtml(unsafe) {
      return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
    }


    function isSelectedDifficulty(state, command) {
      if (state.difficulty === 'easy') {
        return command.command === 'SET_DIFFICULTY_EASY';
      }
      if (state.difficulty === 'medium') {
        return command.command === 'SET_DIFFICULTY_MEDIUM';
      }
      if (state.difficulty === 'expert') {
        return command.command === 'SET_DIFFICULTY_EXPERT';
      }
      return false;
    }


    function renderPreStartConfig(state) {
      const root = document.getElementById('preStartConfigRoot');
      let html = '';
      const difficultyCommands = ['SET_DIFFICULTY_EASY', 'SET_DIFFICULTY_MEDIUM', 'SET_DIFFICULTY_EXPERT'];
      for (const command of difficultyCommands) {
        if (c = hasCommand(state, command)) {
          let text = c.textToSay;
          while (text.startsWith('"')) {
            text = text.substring(1);
          }
          while (text.endsWith('"')) {
            text = text.substring(0, text.length - 1);
          }
          const selected = isSelectedDifficulty(state, c);
          html += `<button style='width:140px' class='${selected ? 'selectedActionButton' : 'actionButton'}' onclick="postCommand('${c.command}')">${text}</button>`;
        }
      }

      html += '<br/>';
      for (let playerCount = 1 ; playerCount <= 10 ; playerCount++) {
        if (c = hasCommand(state, `SET_PLAYER_COUNT_${playerCount}`)) {
          html += `<button style='width:70px' class='${playerCount === state.numberOfPlayers ? 'selectedActionButton' : 'actionButton'}' onclick="postCommand('${c.command}')">${playerCount}</button>`;
        }
      }

      root.innerHTML = html;
    }


    function renderUnrecognizedText(state) {
      const root = document.getElementById('unrecognizedTextRoot');
      let html = '';
      html += `<div class="alert">`;
      if (state.lastPartOfSpeech) {
        if (state.lastPartOfSpeech.iDidntUnderstandLabel) {
          html += `${escapeHtml(state.lastPartOfSpeech.iDidntUnderstandLabel)}: "${escapeHtml(state.lastPartOfSpeech.text)}"`;
        } else {
          html += `"${escapeHtml(state.lastPartOfSpeech.text)}"&nbsp;`;
        }
      } else {
        html += '&nbsp;';
      }
      html += `</div>`;
      root.innerHTML = html;
    }


    function renderMessage(state) {
      const root = document.getElementById('messageRoot');
      let html = '';
      if (state.messageForUser) {
        html += `<br/>`;
        html += `<div class="message">`;
        html += `${escapeHtml(state.messageForUser)}`;
        html += `</div>`;
      }
      root.innerHTML = html;
    }


    function hasTextToSay(state, textToSay) {
      for (let command of state.possibleThingsToSay ?? []) {
        if (command.textToSay === textToSay) {
          return true;
        }
      }
      return false;
    }


    function hasCommand(state, cmd) {
      for (let command of state.possibleThingsToSay ?? []) {
        if (command.command === cmd) {
          return command;
        }
      }
      return undefined;
    }


    function getPointClass(needDoubleToFinish, playerStatus, multiplier, baseValue) {
      const good = isGoodMove(needDoubleToFinish, playerStatus, multiplier, baseValue);
      return good ? ' class="good"' : ' class="bad"';
    }


    function renderTextToSay(state) {
      const textRoot = document.getElementById('textToSayRoot');
      let html = '';
      let c;
      const commandButtons = ['NEW_GAME', 'START_GAME', 'ANSWER_YES', 'ANSWER_NO',
        'CORRECTION', 'NEXT_TURN', 'PAUSE_GAME', 'CONTINUE_GAME', 'STOP_GAME', 'QUIT'];
      if (hasTextToSay(state, '<score>')) {
        const needDoubleToFinish = state.difficulty !== 'easy';
        const playerStatus = state.playerStatuses[state.currentPlayer];
        html += `<table class='scorebuttons'>`;
          for (let row = 1 ; row <= 3 ; row++) {
            html += `<tr>`;
            if (row === 1) {
              html += `<td ${getPointClass(needDoubleToFinish, playerStatus, 0, 0)} onclick="postCommand('SCORE_0x0')">0</td>`;
            } else if (row === 2) {
              html += `<td ${getPointClass(needDoubleToFinish, playerStatus, 1, 25)} onclick="postCommand('SCORE_1x25')">25</td>`;
            } else {
              html += `<td ${getPointClass(needDoubleToFinish, playerStatus, 2, 25)} onclick="postCommand('SCORE_2x25')">50</td>`;
            }

            for (let dart = 1 ; dart <= 20 ; dart++) {
              html += `<td ${getPointClass(needDoubleToFinish, playerStatus, row, dart)} onclick="postCommand('SCORE_${row}x${dart}')">`;
              if (row === 2) {
                html += 'D';
              } else if (row === 3) {
                html += 'T';
              }
              html += `${dart}</td>`;
            }
            html += `</tr>`;
          }
        html += `</table>`;
      }

      html += `<table class="speech">`;
      for (const command of state.possibleThingsToSay ?? []) {
        if (commandButtons.includes(command.command)
            || command.command.startsWith('SET_DIFFICULTY_')
            || command.command.startsWith('SET_PLAYER_COUNT_')) {
          continue;
        }
        if (command.textToSay !== '<score>') {
          html += `<tr class="nonscorespeech" onclick="postCommand('${command.command}')">`;
          html += `<td>${escapeHtml(command.textToSay)}&nbsp;&nbsp;</td>`;
          html += `<td>${escapeHtml(command.description)}&nbsp;&nbsp;</td>`;
          html += `</tr>`;
        } else {
          html += `<tr class="scorespeech">`;
          html += `<td>${escapeHtml(command.textToSay)}&nbsp;&nbsp;</td>`;
          html += `<td>${escapeHtml(command.description)}&nbsp;&nbsp;</td>`;
          html += `</tr>`;
        }
      }

      for (const language of state.alternativeLanguages ?? []) {
        html += `<tr class='lang' onclick="postCommand('${language.command}')">`;
        html += `<td>${escapeHtml(language.textToSay)}&nbsp;&nbsp;</td>`;
        html += `<td>${escapeHtml(language.description)}</td>`;
        html += `</tr>`;
      }

      html += `</table>`;
      for (const command of commandButtons) {
        if (c = hasCommand(state, command)) {
          let text = c.textToSay;
          while (text.startsWith('"')) {
            text = text.substring(1);
          }
          while (text.endsWith('"')) {
            text = text.substring(0, text.length - 1);
          }
          html += `<button class='actionButton' onclick="postCommand('${command}')">${text}</button>`;
        }
      }
      textRoot.innerHTML = html;
    }


    function isGoodMove(needDoubleToFinish, playerStatus, multiplier, baseValue) {
      if (baseValue === 0) {
        return false;
      }
      if (playerStatus.needADoubleToStart && multiplier !== 2) {
        return false;
      }
      if (baseValue * multiplier > playerStatus.score) {
        return false;
      }
      if (baseValue * multiplier === playerStatus.score) {
        if (needDoubleToFinish) {
          return multiplier === 2;
        }
        return true;
      }
      if ((baseValue * multiplier === playerStatus.score - 1) && needDoubleToFinish) {
        return false;
      }
      return true;
    }


    function renderScores(state) {
      const scoreBoardRoot = document.getElementById('scoreBoardRoot');
      if (!state.playerStatuses || state.playerStatuses.length === 0) {
        scoreBoardRoot.innerHTML = '';
        return;
      }

      const N_PLAYERS = state.playerStatuses.length;
      const N_TURNS = state.turn;

      let html = '';
      html += `<br/>`;
      html += `<table id="scores" class="score">`;
      html += `<tr style="color:white;">`;
      html += `<td></td>`;
      html += `<td></td>`;
      for (let turn = 0; turn <= N_TURNS; turn++) {
        html += `<td id="turn${turn}" colspan="3">${turn + 1}</td>`;
      }
      html += `</tr>`;

      for (let p = 0; p < N_PLAYERS; p++) {
        const status = state.playerStatuses[p];
        html += `<tr>`;
        if (p === state.currentPlayer) {
          html += `<td class="currentPlayer">&#9656;${state.playerStatuses[p].description}&nbsp;&nbsp;</td>`;
        } else {
          html += `<td class="player">&nbsp;&nbsp;${state.playerStatuses[p].description}&nbsp;&nbsp;</td>`;
        }
        html += `<td class="score">${status.score}&nbsp;&nbsp;</td>`;
        for (let turn = 0; turn <= N_TURNS; turn++) {
          for (let dart = 0; dart < 3; dart++) {
            const darts = status.dartsPlayed[turn] ?? [];
            let dartDescription = '';
            let ignored = true;
            if (dart < darts.length) {
              const baseValue = darts[dart].baseValue;
              const multiplier = darts[dart].multiplier;
              if (baseValue === 0) {
                dartDescription = '-';
              } else if (baseValue === 25 && multiplier === 2) {
                dartDescription = '50';
                ignored = darts[dart].status !== 'OK';
              } else {
                ignored = darts[dart].status !== 'OK';
                if (multiplier === 2) {
                  dartDescription += `D`;
                } else if (multiplier === 3) {
                  dartDescription += `T`;
                }
                dartDescription += `${baseValue}`;
              }
            }
            if (dart === 2) {
              dartDescription += '&nbsp;&nbsp;';
            }
            if (ignored) {
              html += `<td class="ignored" id="p${p}turn${turn}dart${dart}">${dartDescription}</td>`;
            } else {
              html += `<td class="scorecell" id="p${p}turn${turn}dart${dart}">${dartDescription}</td>`;
            }
          }
        }
        html += `</tr>`;
      }
      html += `</table>`;
      scoreBoardRoot.innerHTML = html;

      // In case there is not enough room to display all turns,
      // let's hide the oldest

      adjustScoreTable(state);
    }

    function hideTurn(n, state) {
      document.getElementById(`turn${n}`).style.display="none";
      for (let p = 0 ; p < state.playerStatuses.length ; p++) {
        document.getElementById(`p${p}turn${n}dart0`).style.display="none";
        document.getElementById(`p${p}turn${n}dart1`).style.display="none";
        document.getElementById(`p${p}turn${n}dart2`).style.display="none";
      }
    }

    function adjustScoreTable(state) {
      const scoreTable = document.getElementById('scores');
      let n = 0
      while (n < state.turn && scoreTable.clientWidth > window.innerWidth) {
        hideTurn(n, state);
        n++;
      }
    }

    function pollGameState() {
      fetch('/state')
        .then(res => res.json())
        .then((gameState) => {
          render(gameState);
        }).catch(err => { throw err });
    }

    function postCommand(command) {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/command', true);
      xhr.setRequestHeader("Content-Type", "application/json");
      const data = JSON.stringify({"command": command});
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          pollGameState();
        }
      };
      xhr.send(data);
    }

    pollGameState();
    // Let's poll for updates every second
    setInterval(() => pollGameState(), 1000);
  </script>
</head>

<body>
  <table style="table-layout: fixed; width:100%">
    <tr>
      <td valign="middle" style="text-align: right;"><img src="dartboard.svg" width='100px'></td>
      <td class="title" valign="middle" style="text-align: center;">&nbsp;Finnegan&nbsp;</td>
      <td valign="middle"><img src="dartboard.svg" width='100px'></td>
    </tr>
  </table>

  <div id='preStartConfigRoot'></div>
  <div id='scoreBoardRoot'></div>
  <div id='messageRoot'></div>
  <div style="position: absolute; bottom: 0; left: 0; width: 100%">
    <div id='textToSayRoot'></div>
    <div id='unrecognizedTextRoot'></div>
  </div>

</body>
</html>